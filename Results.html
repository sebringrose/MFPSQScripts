<style>
    /* CUSTOM BACKGROUND */
    #siteWrapper {
        background: black;
    }
    header {
        background: none !important;
    }
    @media only screen and (min-width: 1200px) {
        #siteWrapper {
            background-image: 
                linear-gradient(#131313c4, #131313c4),
                url('https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_bgScene.jpeg');
            background-repeat: no-repeat;
            background-position: top;
            background-size: contain;
        }
    }

    /* PAGE STYLES */
    #page {
        max-width: 1500px;
        padding: 0px 32px 32px;
    }
    section {
        width: 100%;
        max-width: 100%;
        display: flex;
        flex-wrap: wrap;
    }
    section h1, section h2, section h3, section h4, section p {
        line-height: normal !important;
        font-family: Lato !important;
        color: white !important;
    }
    section h1, section h2, section h3, section h4 {
        font-weight: 600 !important;
    }
    section p {
        font-size: 15px !important;
    }
    #button-section {
        justify-content: center;
    }
    .button-div {
        max-width: 300px;
        min-width: 150px;
        margin: 0 1rem 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .empire-btn img {
        height: 32px;
        margin-right: 5px;
    }
    .carousel-arrow {
        height: 100px;
        margin-top: 50px;
        cursor: pointer;
        filter: brightness(0) saturate(100%) invert(90%) sepia(10%) saturate(4680%) hue-rotate(316deg) brightness(105%) contrast(110%);
    }
    #carousel-items {
        flex: 1; 
        display: flex; 
        justify-content: space-around;
        flex-wrap: wrap;
    }
    .carousel-item {
        width: 300px;
    }
    .film-poster {
        height: 200px;
        box-sizing: border-box;
        border: 10px solid black;
        background-color: darkgrey;
        border-radius: 26px;
        background-size: cover;
    }
    .film-poster img {
        position: relative;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        height: 70px;
        cursor: pointer;
        filter: brightness(0) saturate(100%) invert(100%) sepia(66%) saturate(66%) hue-rotate(213deg) brightness(117%) contrast(100%);
    }
    .info { 
        background-color: rgba(52, 63, 75, 0.57); 
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 5px auto;
        padding: 5px;
    }
    .info * { margin: 5px auto; }
    #overlay-section {
        display: none;
        flex-direction: column;
        max-width: 100vw;
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.4);
        z-index: 999;
        justify-content: center;
        align-items: center;
    }
    #trailer-popup {
        max-width: 560px;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .close-button {
        filter: invert(1);
        cursor: pointer;
        width: 27px;
        height: 27px;
    }
    #trailer_container {
        width: 100%;
        height: 100%;
        max-width: 564px;
        max-height: 234px;
        border: 5px solid white;
        border-radius: 25px;
        box-sizing: border-box;
        overflow: hidden;
    }
    #trailer_player_container {
        width: 100%;
        height: 100%;
    }
</style>

<section id="selected-section">
    <h1 id="selected-title" style="margin: 20px auto;">You Selected: </h1>
</section>

<section id="carousel-section">
    <div id="carousel-left-arrow">
        <img onclick="populatePage()" class="carousel-arrow" src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_chevron.png" alt="left-arrow" style="transform: rotate(90deg);">
    </div>
    <div id="carousel-items">
        <div id="result-1" class="carousel-item">
            <div id="result-1-poster" class="film-poster">
                <img src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_playIcon.png" alt="play">
            </div>
            <div class="info">
                <h4 id="result-1-title">...</h4>
                <p id="result-1-tags">...</p>
            </div>
        </div>
        <div id="result-2" class="carousel-item">
            <div id="result-2-poster" class="film-poster">
                <img src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_playIcon.png" alt="play">
            </div>
            <div class="info">
                <h4 id="result-2-title">...</h4>
                <p id="result-2-tags">...</p>
            </div>
        </div>
        <div id="result-3" class="carousel-item">
            <div id="result-3-poster" class="film-poster" onclick="selectFilm('A World Between Women Teaser Trailer')">
                <img src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_playIcon.png" alt="play">
            </div>
            <div class="info">
                <h4 id="result-3-title">...</h4>
                <p id="result-3-tags">...</p>
            </div>
        </div>
    </div>
    <div id="carousel-right-arrow">
        <img onclick="populatePage()" class="carousel-arrow" src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_chevron.png" alt="left-arrow" style="transform: rotate(270deg);">
    </div>
</section>

<section style="margin-top: 1rem;">
    <p class="info">Press play to watch a 30 second trailer</p>
</section>

<section id="button-section">
    <div class="button-div">
        <button class="empire-btn" onclick="window.location.href = '/'">
            <img alt="results" src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_iconHome.svg">
            Home
        </button>
    </div>
    <div class="button-div">
        <button class="empire-btn" onclick="populatePage()">
            Shuffle again
            <img alt="results" src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_searchIcon.png">
        </button>
    </div>
</section>

<section id="overlay-section">
</section>

<!-- Overlay templates -->
<template id="overlay-loading">
    <img alt="loading" src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_loadingAnimation.gif" style="max-width: 80vw;">
</template>

<template id="overlay-trailer">
    <div id="trailer-popup">
        <img class="close-button" alt="close" src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_closeIcon.png" style="align-self: flex-end;" onclick="overlay('hide')">

        <div id="trailer_container">
            <div id="trailer_player_container"></div>
        </div>
        
        <div style="display: flex;">
            <div class="button-div">
                <button class="empire-btn" onclick="selectFilm()">
                    <img alt="play" src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_sPlayIcon.png">
                    Play full film
                </button>
            </div>
            <div class="button-div">
                <button class="empire-btn" onclick="">
                    <img alt="save" src="https://raw.githubusercontent.com/sebringrose/MinuteSquarespaceScripts/main/assets/Asset_saveIcon.png">
                    Save for later
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Overlay controller -->
<script>
    window.overlay = (templateId, callback) => {
        const overlaySection = document.querySelector("#overlay-section")
        let otherSections = Array.from(document.getElementsByTagName("section"))
        otherSections = otherSections.filter(section => section.id !== "overlay-section")

        if (templateId === "hide") {
            document.body.style.overflow = "scroll"
            overlaySection.innerHTML = ""
            overlaySection.style.display = "none"
            otherSections.forEach(section => section.style.visibility = "visible")
            return callback ? callback() : null
        }
        
        const overlayContent = document.querySelector(templateId)
        if (overlayContent && overlayContent.content) {
            overlaySection.append(overlayContent.content.cloneNode(true))
            document.body.style.overflow = "hidden"
            otherSections.forEach(section => section.style.visibility = "hidden")
            overlaySection.style.display = "flex"
            return callback ? callback() : null
        }
    }
</script>

<!-- EMBEDDED TRAILER PLAYER SCRIPT -->
<!-- This fcn is called as a callback to overlay function when displaying player overlay content -->
<!-- 1. Load FlowPlayer scripts -->
<!-- 2. Use window.selectedFilm as data source for flowplayer fcn -->
<link rel="stylesheet" href="//cdn.flowplayer.com/releases/native/stable/style/flowplayer.css">
<script src="//cdn.flowplayer.com/releases/native/stable/flowplayer.min.js"></script>
<!-- Optional plugins -->
<script src="//cdn.flowplayer.com/releases/native/stable/plugins/hls.min.js"></script>
<script>
    window.playSelectedTrailer = () => {
        console.log('playing', selectedFilm)
        flowplayer('#trailer_player_container', {
            src: selectedFilm.mediafiles.m3u8_url,
            poster: selectedFilm.images.normal_image_url,
            preload: "auto",
            ratio: "564:234",
            autoplay: true,
            token: 'eyJraWQiOiJBblJBR3VYN1lNbDkiLCJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJjIjoie1wiYWNsXCI6NCxcImlkXCI6XCJBblJBR3VYN1lNbDlcIixcImRvbWFpblwiOltcInd3dy5taW51dGVzaG9ydHMuY28udWtcIixcImp1bGlhbi12aWZvci5zcXVhcmVzcGFjZS5jb21cIl19IiwiaXNzIjoiRmxvd3BsYXllciJ9.ZQ_BBs6sCSvis4skaHIeZIyGKUSGRtaGFtix7RXZh53G1QzHN8ooMdE_N-8OcuYi_ePDeL1cAAzpPTeACQ2wAQ'
        })
    }
</script>

<!-- POPULATE PAGE CONTENT FUNCTION -->
<script>
    window.populatePage = async () => {
        // get tag from URL and write to selected-title
        const tagParam = decodeURIComponent(new URLSearchParams(window.location.search).get('t'))
        if (!tagParam || tagParam === "null") return alert("No film tag provided. Please go to home page and select an option.")
        document.querySelector("#selected-title").textContent = `You Selected: ${tagParam}`

        // display loading animation
        overlay("#overlay-loading")

        // fetches set of film trailers that match tag
        let films = await fetch(`https://flowplayer-middleware.azurewebsites.net/api/getVideo?code=71QIkhIZbREwZek4nRNjIjSsWJcu7GAbKncFKnz30JGviBDCxokuog%3D%3D&tags=${encodeURIComponent(tagParam)},film_trailer&pageSize=6`)
            .then(response => response.json())
        
        // alert user if no matching films found
        if (!films[0]) alert("No films matching supplied tag found! Please go to home page and try another option.")

        // remove any repeat results (only if we have enough results)
        let prevFilms = localStorage.getItem('results') ? JSON.parse(localStorage.getItem('results')).films : null
        if (prevFilms && films.length > prevFilms.length) films.filter(film => prevFilms.some(prevFilm => film.name !== prevFilm.name))

        // store tag and film results in localStorage.
        // this is used to make sure not to display repeat options on shuffle
        // and to correctly route back to same results from player page.
        localStorage.setItem('results', JSON.stringify({ tagParam, films }))

        // hide loading animation
        overlay("hide")

        // write film data into carousel items
        for (let i=0; i<3; i++) {
            if (!films[i]) {
                document.querySelector(`#result-${i+1}`).style.display = "none"
                continue
            }

            const poster = document.querySelector(`#result-${i+1}-poster`)
            poster.style.backgroundImage = `url(${films[i].images.normal_image_url})`
            poster.onclick = () => {
                window.selectedFilm = films[i]
                overlay("#overlay-trailer", playSelectedTrailer)
            }

            const title = document.querySelector(`#result-${i+1}-title`)
            title.textContent = films[i].name

            const tags = document.querySelector(`#result-${i+1}-tags`)
            const hiddenTags = [ "film_trailer" ]
            hiddenTags.push(tagParam)

            let filmTags = films[i].tags.split(",")
            let tagString = ""
            filmTags.forEach(tag => hiddenTags.every(hTag => hTag !== tag) 
                ? tagString += `${tag}, `
                : null
            )
            tags.textContent = tagString ? `(${tagString})` : ""
        }
    }
    
    // initial page load
    populatePage()
</script>

<!-- SELECT FILM FUNCTION -->
<script>
    window.selectFilm = () => {
        const name = selectedFilm.name

        // trailer-specific part of name
        const trailerString = " Trailer"
        if (!name.includes(trailerString)) return alert("Incorrect trailer name. Please contact an admin to resolve this issue.")
        
        // remove trailer-specific name part
        const filmName = name.slice(0, name.indexOf(trailerString))

        window.location.href = `/player?id=${encodeURIComponent(filmName)}`
    }
</script>